<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ポケスリ食材計算ツール</title>
  <link rel="stylesheet" href="css/style.css" />
</head>
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-Y5J6145CMR"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-Y5J6145CMR');
</script>
<body>
  <h1>ポケスリ食材計算ツール</h1>

  <!-- コントロール -->
<div class="card controls">
  <div class="controls-row">
    <label>今週のレシピ</label>
    <div id="genreRadios"></div>
  </div>

  <div class="controls-row">
    <label>レシピ
      <div id="recipeSelect" class="custom-select">
        <div class="cs-selected" id="csSelected" tabindex="0" aria-haspopup="listbox" aria-expanded="false">
          <div class="name" id="csSelName">--レシピを選択--</div>
          <div class="thumbs" id="csSelThumbs"></div>
        </div>
        <div class="cs-items cs-hide" id="csItems" role="listbox" aria-label="レシピ一覧"></div>
      </div>
    </label>
    <div id="recipePreview" class="recipe-preview"></div>
  </div>

  <div class="controls-row">
    <label>個数
      <div class="inline">
        <input id="qtyInput" type="number" min="1" value="1" class="qty" />
        <button id="addBtn">追加</button>
      </div>
    </label>
  </div>
</div>

  <!-- 登録済みレシピ -->
  <div class="card">
    <div class="flex-between">
      <h3 style="margin:0">追加済みレシピ</h3>
      <!-- ★ 右側の表記を削除し、全削除ボタンをここに配置 -->
      <button id="clearBtn" class="ghost">全削除</button>
    </div>
    <div id="addedListPC" class="list" style="margin-top:8px"></div>
    <div id="addedListSP" class="list" style="margin-top:8px"></div>
  </div>

<!-- 食材合計 -->
<div class="card">
  <div class="flex-between">
    <h3 style="margin:0">食材合計</h3>
    <!-- 右上：所持数リセット -->
    <button id="resetStockBtn" class="ghost">所持数リセット</button>
  </div>

  <!-- 置換後：ツールバーを左右に分け、左を縦積み -->
  <div class="cam-left">
    <div class="cam-top-row">
      <button id="toggleOcrBtn" class="icon-btn" aria-expanded="false">📷</button>
      <button id="gridDefaultsBtn" class="icon-btn" title="既定値に戻す" style="display:none;">↺</button>
    </div>
    <p id="cameraHelp" class="camera-help"><small>
      食材バッグのスクショ画像から食材を読み取ります。(β)<br>
      一番下までスクロールした画像を用意してください。<br>
      (Galaxy S24のみ動作確認済み)
      </small>
    </p>
  </div>

  <!-- ★ カメラで開くOCRインラインパネル（テーブルの“上”） -->
  <div id="ocrPanel" class="ocr-inline" style="display:none">
    <div class="controls-row" style="flex-wrap:wrap">
      <!-- ボタン範囲限定のドロップゾーン（単一IDに統一） -->
      <div id="screenshotDrop" class="drop-button" role="button" tabindex="0"
          aria-label="スクショを選択（クリック or ドロップ）">
        <!-- ※ 視覚的なテキストは出さず、アクセシビリティは aria-label で担保 -->
        <input id="invImage" type="file" accept="image/*" />
      </div>
      <div style="flex-basis:100%;height:0"></div>
      <!-- 置換後：行数セグメント＋読取、裏で #ocrRows を保持 -->
      <div class="ocr-rows">
        <div class="seg" id="ocrRowSeg">
          <button type="button" class="seg-btn" data-val="1">1</button>
          <button type="button" class="seg-btn is-active" data-val="2">2</button>
          <button type="button" class="seg-btn" data-val="3">3</button>
          <button type="button" class="seg-btn" data-val="4">4</button>
        </div>
        <span class="small unit">(行)</span>

        <!-- 垂直オフセット（箱全体の上下移動。箱サイズは固定） -->
        <div class="field">
          <label for="ocrYOffset" class="visually-hidden">(垂直)</label>
          <div class="range">
            <input id="ocrYOffset" type="range" min="-200" max="200" step="1" value="0" />
            <span class="mini-label-inline">(垂直)</span>
            <span id="ocrYOffsetVal">0</span>
          </div>
        </div>

        <label for="ocrGapX" class="visually-hidden">(間隔)</label>
          <div class="range">
            <input id="ocrGapX" type="range" min="10" max="60" step="1" value="24" />
            <span class="mini-label-inline">(間隔)</span>
            <output id="ocrGapXVal" class="small">24px</output>
          </div>
        </label>
        <!-- ★ この1行をボタンの直前に追加 -->
        <div class="flex-br"></div>

        <button id="gridOcrBtn">読取</button>


        <!-- 裏方：ocr.js が読む値はここ（hidden） -->
        <input id="ocrRows" type="number" value="4" min="1" max="4" hidden />
      </div>

      <div id="ocrStatus" class="small" style="align-self:center;color:#666"></div>
    </div>

    <canvas id="gridPreview" style="display:none"></canvas>
    <div id="tileThumbs" style="display:flex; gap:6px; flex-wrap:nowrap; overflow-x:auto; margin-top:8px"></div>
    <div id="ocrResult" style="margin-top:8px"></div>
  </div>

  <!-- テーブル本体 -->
  <div id="totalsWrap" style="overflow:auto">
      <table id="totalsTable">
      <colgroup>
        <col>
        <col class="num-col">
        <col class="num-col">
        <col class="num-col">
      </colgroup>
      <thead>
        <tr>
          <th class="th-ing">
            <div class="th-stack">
              <button id="toggleNameBtn" class="icon-btn tiny" title="食材名の表示/非表示">＋</button>
              <span>食材</span>
            </div>
          </th>
          <th style="text-align:center">必要数</th>
          <th style="text-align:center">所持数</th>
          <th style="text-align:center">不足数</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

  <!-- スクリプト -->
  <script src="js/data.js"></script>
  <script src="https://unpkg.com/tesseract.js@5.0.2/dist/tesseract.min.js"></script>
  <script src="js/utils.js"></script>
  <script src="js/app.js"></script>
  <script src="js/ocr.js"></script>
</body>
</html>
